---
title: 本站 - 代码块隐藏模块
date: 2022-02-13 19:18:07
permalink: /about/website/code-block-hidden/
titleTag: 原创
categories:
  - 关于 - 本站
tags: 
  - 本站
---

::: note

一个代码块的代码太多，会占据大量的篇幅，如果能选择性隐藏，那么页面也许更加好看。

::: right

2021-01-11 @Young Kbt

:::

[[TOC]]



## 前言

代码块可以隐藏，也可以展开，这和 `::: details` 类似，下面是简单的代码块 Demo：

```java
public class Hello {
    public static void main(String[] args) {
        System.out.println("Hello，World")
    }
}
```

看到代码块右边的箭头了吗，点击即可隐藏代码块，再次点击则会展开代码块。

本内容实现并不难，只需三步：

- 添加箭头图标
- 编写代码块隐藏和展开的 Vue 组件
- 全局注册 Vue 组件

## 添加箭头图标

图标库来自阿里云：`https://www.iconfont.cn/`。

如果你没有账号，或者觉得添加比较麻烦，就使用我的图标库地址，**当你发现图标失效了，就请来这里获取新的地址，如果还没有更新，请在评论区留言**。

当然，建议你使用自己的图标库，比较稳定。

在 docs/.vuepress/config.js（新版是 config.ts）的 head 模块里添加如下内容：

```js
['link', { rel: 'stylesheet', href: '//at.alicdn.com/t/font_3114978_qe0b39no76.css' }],['link', { rel: 'stylesheet', href: '//at.alicdn.com/t/font_3114978_qe0b39no76.css' }],
```

## 添加Vue组件

在 docs/.vuepress/components 目录下创建 Vue 组件：`BlockToggle.vue`。如果不存在 components 目录，则请创建。

添加如下内容：

```vue
<template></template>

<script>
export default {
  mounted() {
    setTimeout(() => {
      this.addExpand(40);
    }, 1000);
  },
  watch: {
    $route(to, from) {
      setTimeout(() => {
        this.addExpand(40);
      }, 1000);
    },
  },
  methods: {
    // 隐藏代码块后，保留 40 的代码块高度
    addExpand(hiddenHeight = 40) {
      let modes = document.getElementsByClassName("line-numbers-mode");
      // 遍历出每一个代码块
      for (let i = 0; i < modes.length; i++) {
        // 首先获取 expand 元素
        let expand = modes[i].getElementsByClassName("expand")[0];
        // expand 元素不存在，则进入 if 创建
        if (!expand) {
          // 获取代码块原来的高度，进行备份
          let modeHeight = modes[i].offsetHeight;
          // display:none 的代码块需要额外处理
          if (modeHeight == 0) {
            modeHeight = this.getHiddenElementHight(modes[i]);
          }
          // modeHeight 比主题多 12，所以减掉，并显示赋值，触发动画过渡效果
          modeHeight -= 12;
          modes[i].style.height = modeHeight + "px";
          // 获取代码块的各个元素
          let pre = modes[i].getElementsByTagName("pre")[0];
          let wrapper = modes[i].getElementsByClassName(
            "line-numbers-wrapper"
          )[0];
          // 创建箭头元素
          const div = document.createElement("div");
          div.className = "expand icon-xiangxiajiantou iconfont";
          // 箭头点击事件
          div.onclick = () => {
            // 代码块已经被隐藏，则进入 if 循环，如果没有被隐藏，则进入 else 循环
            if (parseInt(modes[i].style.height) == hiddenHeight) {
              div.className = "expand icon-xiangxiajiantou iconfont";
              modes[i].style.height = modeHeight + "px";
              setTimeout(() => {
                pre.style.display = "block";
                wrapper.style.display = "block";
              }, 80);
            } else {
              div.className = "expand icon-xiangxiajiantou iconfont closed";
              modes[i].style.height = hiddenHeight + "px";
              setTimeout(() => {
                pre.style.display = "none";
                wrapper.style.display = "none";
              }, 300);
            }
          };
          modes[i].append(div);
        }
      }
    },
    getHiddenElementHight(hiddenElement) {
      let modeHeight;
      if (
        hiddenElement.parentNode.style.display == "none" ||
        hiddenElement.parentNode.className !=
          "theme-code-block theme-code-block__active"
      ) {
        hiddenElement.parentNode.style.display = "block";
        modeHeight = hiddenElement.offsetHeight;
        hiddenElement.parentNode.style.display = "none";
        // 清除 vuepress 自带的 deetails 多选代码块
        if (hiddenElement.parentNode.className == "theme-code-block") {
          hiddenElement.parentNode.style.display = "";
        }
      }
      return modeHeight;
    },
  },
};
</script>

<style>
.line-numbers-mode {
  overflow: hidden;
  transition: height 0.3s;
}
.expand {
  width: 16px;
  height: 16px;
  cursor: pointer;
  position: absolute;
  z-index: 3;
  top: 0.8em;
  right: 4.5em;
  color: rgba(150, 150, 150, 0.7);
  font-weight: 900;
  transition: transform 0.3s;
}
.theme-vdoing-content pre[class*="language-"] {
  margin: 0 0 0.85rem 0 !important;
}
.closed {
  transform: rotate(90deg) translateY(-3px);
  transition: all 0.3s;
}
.code-copy {
  top: 0.8rem !important;
}
</style>
```

第 7 行和第 13 行的参数 40 是隐藏代码块后，保留代码块高度，40 是默认值。

## 注册Vue组件

在 docs/.vuepress/config.js（新版是 config.ts）的 plugins 中添加插件配置。

添加如下内容：

```js
module.exports = {
    plugins: [
        {
            name: 'custom-plugins',
            globalUIComponents: ["BlockToggle"] // 2.x 版本 globalUIComponents 改名为 clientAppRootComponentFiles
        }
    ],
}
```

## 结束语

如果你还有疑惑，可以去我的 GitHub 仓库或者 Gitee 仓库查看源码。

GitHub：<https://github.com/Kele-Bingtang/Kele-Bingtang.github.io>

Gitee：<https://gitee.com/kele-bingtang/Kele-Bingtang>

如果你有更好的方式，评论区留言告诉我，谢谢！